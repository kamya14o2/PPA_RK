---
title: "Can recidivism be predicted?"
author: "Kamya Khandelwal, Revathi Machan, Claudia Schreier"
date: "September 18,2022"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# Recidivism in the State of Georgia

As a side quest from his mission of removing reproductive rights as the Governor of Georgia, Brian Kemp has asked the team at Marie Antoinette Predictions (MAP) to create a model to predict recidivism, or the probability that someone convicted of a crime will be convicted of another crime in the future. Georgia is one of the leading states with the highest per capita amount of people under correctional supervision. Nationally, around 65 percent of formerly incarcerated people will reoffend, and 30 percent of people will find themselves back in prison within three years, making this issue one of high importance for criminal justice reforms. Recidivism costs the state a lot of money, from continued legal fees and resources for incarcerated individuals. Research about recidivism has been embedded into the management framework of the National Institute of Justice (NIJ), an organization that sponsors government-funded criminal justice research. the NIJ believes that studying recidivism is "one of the most fundamental concepts in criminal justice" because it is something that prison re-entry programs actively are designed to avoid. 

## Introducing our work

Recidivism is a concept to study in a data-driven approach. MAP obtained a dataset from the NIG with re-entry data, including the original crime, some demographic information, and other types of personal information about the incarcerated individual, along with whether or not the person was convicted of another crime. Using linear models, we can predict whether or not a person will be convicted of a second crime after leaving prison.

The models that are created to predict recidivism can either prioritize specificity or sensitivity. Specificity is the ability of a test to correctly identify true negatives. In this case, a true negative would be that Marie Antoinette Predictions predicts that recidivism will not occur, but it will. A high specificity model indicates that there is a low rate of false positives. Sensitivity is the ability of a test to correctly identify true positives. A high sensitivity model indicates that that there is a low rate of false negatives; for recidivism, this means that the model correctly identifies individuals who will be convicted of another crime after previously being incarcerated. There are benefits and drawbacks to both high sensitivities and specificities, but there usually cannot be both. In either case, there will be a group of individuals who in prediction are mis-classified. What kind of error will Governor Brian Kemp accept in reforming Georgia's criminal justice system?

```{r load_packages, warning = FALSE, include = FALSE}
options(scipen=10000000)


if(!require(pacman)){install.packages("pacman"); library(pacman)}
p_load(tidyverse, kableExtra, caret, knitr, pscl, plotROC, pROC, lubridate, sf, tidycensus, RSocrata, viridis, spatstat, raster, spdep, FNN, grid, gridExtra, classInt, mice)

root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

```

```{r load_data, cache = TRUE, include = FALSE}
palette5 <- c("#981FAC","#CB0F8B","#FF006A","#FE4C35","#FE9900")
palette4 <- c("#981FAC","#FF006A","#FE4C35","#FE9900")
palette2 <- c("#981FAC","#FF006A")

policeDistricts <- 
  st_read("https://data.cityofchicago.org/api/geospatial/fthy-xz3r?method=export&format=GeoJSON") %>%
  st_transform('ESRI:102271') %>%  
  dplyr::select(District = dist_num)  

# Read and process police beats data
policeBeats <- 
  st_read("https://data.cityofchicago.org/api/geospatial/aerh-rz74?method=export&format=GeoJSON") %>%
  st_transform('ESRI:102271') %>%  
  dplyr::select(District = beat_num)  

# Combine police districts and beats data into one dataframe
bothPoliceUnits <- rbind(
  mutate(policeDistricts, Legend = "Police Districts"), 
  mutate(policeBeats, Legend = "Police Beats")  
)

#Read and process deceptive practice data
deceptivePractice <- 
  read.socrata("https://data.cityofchicago.org/Public-Safety/Crimes-2017/d62x-nvdr") %>% 
  filter(Primary.Type == "DECEPTIVE PRACTICE") %>%  
  mutate(x = gsub("[()]", "", Location)) %>%  
  separate(x, into = c("Y", "X"), sep = ",") %>%  
  mutate(X = as.numeric(X), Y = as.numeric(Y)) %>%  
  na.omit() %>%  
  st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>%  
  st_transform('ESRI:102271') %>% 
  distinct()  

# Read and process Chicago boundary data
chicagoBoundary <- 
  st_read(file.path(root.dir, "/Chapter5/chicagoBoundary.geojson")) %>%  
  st_transform('ESRI:102271') 


rDivism <-
  read_csv("https://data.ojp.usdoj.gov/resource/ynf5-u8nk.csv")

```

# Exploring our model's components

```{r exploratory_continuous, results = 'hide'}
rDivism %>%
  dplyr::select(gender,gang_affiliated, age_at_release, education_level, prison_offense, prison_years, recidivism_within_3years) %>%
  gather(Variable, value, -recidivism_within_3years) %>%
    ggplot(aes(recidivism_within_3years, value, fill=recidivism_within_3years)) + 
      geom_bar(position = "dodge", stat = "summary", fun = "mean") + 
      facet_wrap(~Variable, scales = "free") +
      scale_fill_manual(values = palette2) +
      labs(x="Recidivism", y="Value", 
           title = "Feature associations with the likelihood of recidivism",
           subtitle = "(continous outcomes)") +
      theme(legend.position = "none")
```

```{r exploratory_continuous_density, message = FALSE, warning = FALSE, results = 'hide'}
rDivism %>%
    dplyr::select(gender,gang_affiliated, age_at_release, education_level, prison_offense, prison_years, recidivism_within_3years) %>%
    gather(Variable, value, -recidivism_within_3years) %>%
    ggplot() + 
    geom_density(aes(value, color=recidivism_within_3years), fill = "transparent") + 
    facet_wrap(~Variable, scales = "free") +
    scale_fill_manual(values = palette2) +
    labs(title = "Feature distributions recidivism vs. no recidivism",
         subtitle = "(continous outcomes)")
```

```{r exploratory_binary, message = FALSE, warning = FALSE}
rDivism %>%
    dplyr::select(gender, prison_offense, prison_years, recidivism_within_3years) %>%
    gather(Variable, value, -recidivism_within_3years) %>%
    count(Variable, value, recidivism_within_3years) %>%
      ggplot(., aes(value, n, fill = recidivism_within_3years)) +   
        geom_bar(position = "dodge", stat="identity") +
        facet_wrap(~Variable, scales="free") +
        scale_fill_manual(values = palette2) +
        labs(x="Click", y="Value",
             title = "Feature associations with the likelihood of recidivism",
             subtitle = "Categorical features") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r country_variables, cache = TRUE}
rDivism <- 
  rDivism %>% 
  group_by(prison_offense) %>% 
  summarize(totRD = sum(recidivism_within_3years), #except this is not a numeric thing its a binary thing 
            n = n(), 
            nationalrDivism = 100*(totRD/n)) %>%
  dplyr::select(-n, -totRD) %>%
  right_join(rDivism, .) %>%
    mutate(ageTimeFrame = case_when(age_at_release <= 32 ~ "Young",
                                  age_at_release > 33 & age_at_release <= 42 ~ "Middle Aged", 
                                  age_at_release > 43 & age_at_release <= 48 ~ "Old",
                                  age_at_release > 48 ~ "Very Old"))

rDivism <- rDivism %>%
  mutate(prior_arrest_episodes_misd = as.factor(ifelse(prior_arrest_episodes_misd == "6 or more", "6", prior_arrest_episodes_misd)),
         prior_arrest_episodes_felony = as.factor(ifelse(prior_arrest_episodes_felony == "10 or more", "10", prior_arrest_episodes_felony)))
```

# Creating a logistic regression model

Our logistic regression model predicts a binary outcome. For Brian Kemp, that means there are two (2) options - a *1* or a *0*. A 1 indicates that there was recidivism, and a 0 indicates that were was not. There are also associates probabilities that can affet the outcome depending on the specific variables in the model. To create and test this model, we took our large NIJ dataset and split it into two equal parts - a training and a testing dataset. 

When running the model, the depending variable is called 'rDivismNumeric' which is the binary outcome of recidivism instead of a TRUE/FALSE outcome. 

```{r create_partition, results = 'hide'}
set.seed(3456)

rDivism$rDivismNumeric <-
  ifelse(rDivism$recidivism_within_3years == "TRUE", 1,0)

trainIndex <- createDataPartition(rDivism$recidivism_within_3years, p = 0.50, #splitting into 50-50 in training and testing models
                                  list = FALSE,
                                  times = 1)
rDivismTrain <- rDivism[ trainIndex,]
rDivismTest  <- rDivism[-trainIndex,]
```

```{r run_model, results = 'hide'}
#not working and idk why - confused about the glm part
rDivismModel <- glm(rDivismNumeric ~ ., #glm is generalized linear model, taking in the defaults
                    data=rDivismTrain %>% 
                    dplyr::select(-prison_offense, -gender, -recidivism_within_3years),
                  family="binomial"(link="logit"))
# i added gender into the model instead of agetime - if we want a more temporal variable
# we can add it too
summary(rDivismModel)
```

```{r second_model, results = 'hide'}
rDivismModel2 <- glm(rDivismNumeric ~ .,
                  data=rDivismTrain %>% dplyr::select(-prison_offense, -prison_years, -gender, -race, -education_level),
                  family="binomial" (link="logit"))

summary(rDivismModel2)

```

```{r fit_metrics, results = 'hide'}

pR2(rDivismModel2) #McFadden is pseudo R squared

```

```{r testProbs}
#if(class(rDivismTest$prior_arrest_episodes_felony) == "character") {rDivismTest$prior_arrest_episodes_felony <- as.numeric(rDivismTest$prior_arrest_episodes_felony)}

rDivismModel$xlevels[["prior_arrest_episodes_felony"]] <- union(rDivismModel$xlevels[["prior_arrest_episodes_felony"]], levels(rDivismTest$prior_arrest_episodes_felony))


#rDivismTest$prior_arrest_episodes_felony[is.na(rDivismTest$prior_arrest_episodes_felony)] <- 9
levels_train <- levels(rDivismTrain$prior_arrest_episodes_felony)

# Relevel the factor variable in the new data
rDivismTest$prior_arrest_episodes_felony <- factor(rDivismTest$prior_arrest_episodes_felony, levels = levels_train)

testProbs <- data.frame(#class = rDivismTest$recidivism_within_3years,
                        Outcome = as.factor(rDivismTest$rDivismNumeric),
                        Probs = predict(rDivismModel, rDivismTest, type= "response"))

```

```{r plot_testProbs}
ggplot(testProbs, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ . ) +
  scale_fill_manual(values = palette2) +
  ylim(0,1)+
  labs(x = "Recidivism", y = "Density of probabilities",
       title = "Distribution of predicted probabilities by observed outcome") +
  theme(strip.text.x = element_text(size = 18),
        legend.position = "none")
```

## Confusion Matrix

```{r thresholds}
testProbs <- 
  testProbs %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs$Probs > 0.5 , 1, 0))) #setting threshold of 50%
```

```{r confusion_matrix}
caret::confusionMatrix(testProbs$predOutcome, testProbs$Outcome, 
                       positive = "1") #sensitivity tells us how good at predicting the 1, i.e. true positives. specificity is how good are we at predicting the 0, i.e. true negatives.

```

## ROC Curve

```{r auc, message = FALSE, warning = FALSE}
#roc_object <- roc(testProbs$Outcome, testProbs$predOutcome)

#auc(as.numeric(testProbs$Outcome), as.numeric(testProbs$Probs))
#auc(testProbs)
```

```{r roc_curve, warning = FALSE, message = FALSE}
ggplot(testProbs, aes(d = as.numeric(Outcome), m = Probs)) +
  geom_roc(n.cuts = 50, labels = FALSE, colour = "#FE9900") +
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') +
  labs(title = "ROC Curve - Recidivism Model")
```


## Model Accuracy
this would include the model accuracy and the error, summary stats by race, and discussion.

```{r cv}

######
# EVERYTHING HIGHLIGHTED SHOULD BE THE WAY TO GO ITS JUST NOT WORKING
######

#rDivism <- rDivism %>%
 # mutate(numeric_recidivism_within_3years = rDivism$recidivism_within_3years)

#rDivismTest$recidivism_within_3years[rDivismTest$recidivism_within_3years == "TRUE"] <- 1
#rDivismTest$recidivism_within_3years[rDivismTest$recidivism_within_3years == "FALSE"] <- 0
#rDivismTest$recidivism_within_3years <- as.integer(rDivismTest$recidivism_within_3years)

# Convert 'recidivism_within_3years' to numeric
#rDivism$RD <- as.numeric(as.character(rDivism$recidivism_within_3years))

# Define train control
ctrl <- trainControl(method = "cv", number = 100, classProbs = TRUE, summaryFunction = twoClassSummary)

#rDivismTest$recidivism_within_3years[is.nan(rDivismTest$recidivism_within_3years)] <- NA
#rDivismTest$recidivism_within_3years <- na.exclude(rDivismTest$recidivism_within_3years)

#rDivism$prior_arrest_episodes_felony[is.nan(rDivism$prior_arrest_episodes_felony)] <- NA
#rDivism$prior_arrest_episodes_felony <- na.exclude(rDivism$prior_arrest_episodes_felony)

#rDivismTest$prison_offense[is.nan(rDivismTest$prison_offense)] <- NA
#rDivismTest$prison_offense <- na.exclude(rDivismTest$prison_offense)

rDivism <- drop_na(rDivism)
rDivismTest <- drop_na(rDivismTest)
rDivism$prior_arrest_episodes_felony <- as.numeric(rDivism$prior_arrest_episodes_felony)
rDivismTest$prior_arrest_episodes_felony <- as.numeric(rDivismTest$prior_arrest_episodes_felony)

#notnew and this worked
rDivism$recidivism_within_3years <- factor(rDivism$recidivism_within_3years)
levels(rDivism$recidivism_within_3years) <- make.names(levels(rDivism$recidivism_within_3years))

#new
rDivismTest$recidivism_within_3years <- factor(rDivismTest$recidivism_within_3years)
levels(rDivismTest$recidivism_within_3years) <- make.names(levels(rDivismTest$recidivism_within_3years))

#names(rDivismTest)[names(rDivismTest) == "Probs"] <- "classProbs"

# Train the model
cvFit <- train(recidivism_within_3years ~ .,
               data = rDivismTest %>% 
               dplyr::select(-prison_offense, -gender, -prior_arrest_episodes_felony,
                            -rDivismNumeric),
               method = "glm", 
               family = "binomial",
               metric = "ROC", 
               trControl = ctrl)

# View the results
cvFit


```

```{r goodness_metrics, message = FALSE, warning = FALSE}
dplyr::select(cvFit$resample, -Resample) %>%
  gather(metric, value) %>%
  left_join(gather(cvFit$results[2:4], metric, mean)) %>%
  ggplot(aes(value)) + 
    geom_histogram(bins=35, fill = "#FF006A") +
    facet_wrap(~metric) +
    geom_vline(aes(xintercept = mean), colour = "#981FAC", linetype = 3, size = 1.5) +
    scale_x_continuous(limits = c(0, 1)) +
    labs(x="Goodness of Fit", y="Count", title="CV Goodness of Fit Metrics",
         subtitle = "Across-fold mean reprented as dotted lines")

```

## Cost-Benefit calculation of recidivism vs. continued jail-time

methods and discussion here

```{r cost_benefit}
cost_benefit_table <-
   testProbs %>%
      count(predOutcome, Outcome) %>%
      summarize(True_Negative = sum(n[predOutcome==0 & Outcome==0]),
                True_Positive = sum(n[predOutcome==1 & Outcome==1]),
                False_Negative = sum(n[predOutcome==0 & Outcome==1]),
                False_Positive = sum(n[predOutcome==1 & Outcome==0])) %>%
       gather(Variable, Count) %>%
       mutate(Revenue =
               ifelse(Variable == "True_Negative", Count * 0,
               ifelse(Variable == "True_Positive",((.35 - .1) * Count),
               ifelse(Variable == "False_Negative", (-0.35) * Count,
               ifelse(Variable == "False_Positive", (-0.1) * Count, 0))))) %>%
    bind_cols(data.frame(Description = c(
              "We correctly predicted no recidivism",
              "We correctly predicted recidivism",
              "We predicted no recidivism and there was",
              "We predicted recidivism and there wasn't")))

kable(cost_benefit_table,
       caption = "Cost/Benefit Table") %>% kable_styling()
```

```{r iterate_threshold}
iterateThresholds <- function(data) {
  x = .01
  all_prediction <- data.frame()
  while (x <= 1) {
  
  this_prediction <-
      testProbs %>%
      mutate(predOutcome = ifelse(Probs > x, 1, 0)) %>%
      count(predOutcome, Outcome) %>%
      summarize(True_Negative = sum(n[predOutcome==0 & Outcome==0]),
                True_Positive = sum(n[predOutcome==1 & Outcome==1]),
                False_Negative = sum(n[predOutcome==0 & Outcome==1]),
                False_Positive = sum(n[predOutcome==1 & Outcome==0])) %>%
     gather(Variable, Count) %>%
     mutate(Revenue =
               ifelse(Variable == "True_Negative", Count * 0,
               ifelse(Variable == "True_Positive",((.35 - .1) * Count),
               ifelse(Variable == "False_Negative", (-0.35) * Count,
               ifelse(Variable == "False_Positive", (-0.1) * Count, 0)))),
            Threshold = x)
  
  all_prediction <- rbind(all_prediction, this_prediction)
  x <- x + .01
  }
return(all_prediction)
}
```

```{r revenue_model}
whichThreshold <- iterateThresholds(testProbs2)

whichThreshold_revenue <- 
whichThreshold %>% 
    group_by(Threshold) %>% 
    summarize(Revenue = sum(Revenue))

  ggplot(whichThreshold_revenue)+
  geom_line(aes(x = Threshold, y = Revenue))+
  geom_vline(xintercept =  pull(arrange(whichThreshold_revenue, -Revenue)[1,1]))+
    labs(title = "Model Revenues By Threshold For Test Sample",
         subtitle = "Vertical Line Denotes Optimal Threshold")

```

# Conclusion

* Model finding 1

* This model should be used with caution. While it may be able to predict recidivism, it might highlight 

* Models like this one are dangerous to use in the criminal justice system. While it is important to use data-drive approaches to understand phenomenon in our system, this model is not in-depth enough to catch nuances of why or how someone becomes part of the recidivism category.
* The criminal justice system is ultimately very flawed, as prison re-entry programs very state by state. This model does not account for re-entry, which is a large part of the statistics regarding recidivism.
  + Re-entry, or programs that prepare incarcerated individuals for life after being released, should begin from the day that they step foot into prison. 
  + Re-entry programs should include education, job training, mental and physical healthcare, and financial training. Many states do not have re-entry programs unless it is for incarcerated people about to be released. 
  + The unemployment rate for formerly incarcerated people is much higher than the national average. Additionally, the rate of formerly incarcerated people without a GED, high school diploma, or college degree is also much higher than the national average. Poverty is the largest indicator of recidivism, and re-entry programs need to include anti-poverty strategies within programming.

* There is no benefit to keeping incarcerated people in prison past when is needed for the goal of cutting costs. Prison systems should be focused on rehabilitation instead of predicting future crime - while there are predictors of recidivism that could be generally accurate, re-entry programs can change the rate of recidivism.  

